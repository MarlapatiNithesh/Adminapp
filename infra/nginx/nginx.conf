user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events { 
    worker_connections 8192;   # allow many concurrent connections
    multi_accept on;           # accept multiple connections at once
    use epoll;                 # Linux high-performance
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    # Gzip compression for better throughput
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/xml text/xml text/javascript image/svg+xml;

    # Proxy cache
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATICCACHE:50m max_size=2g inactive=7d use_temp_path=off;
    proxy_cache_key "$scheme$request_method$host$request_uri";

    # Remove rate limiting for high load
    # limit_req_zone  $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # limit_conn_zone $binary_remote_addr zone=perip:10m;

    # WebSocket helper
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Cache bypass maps
    map $request_method $bypass_post       { default 0; POST 1; }
    map $http_authorization $bypass_auth   { default 0; ~.+ 1; }
    map $cookie_session $bypass_cookie     { default 0; ~.+ 1; }
    map "$bypass_post$bypass_auth$bypass_cookie" $skip_cache { default 0; ~[1] 1; }

    # Include all server configs
    include /etc/nginx/conf.d/*.conf;
}


