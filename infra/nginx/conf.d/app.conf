# HTTP on your public IP
server {
  listen 80;
  server_name 72.60.96.189;  # IP only, no port here

  # Basic security headers (still useful on HTTP)
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header X-XSS-Protection "1; mode=block" always;

  # Rate/connection limits
  limit_req zone=api_limit burst=20 nodelay;
  limit_conn perip 40;

  # Cache defaults (safe GETs)
  proxy_cache STATICCACHE;
  proxy_cache_lock on;
  proxy_cache_valid 200 10m;
  proxy_cache_valid 404 1m;

  location / {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSockets
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Bypass cache for POST/auth/session cookies
    proxy_no_cache     $skip_cache;
    proxy_cache_bypass $skip_cache;

    proxy_read_timeout 60s;
    proxy_pass http://app_upstream;
  }
}

